name: Symbiotic PR Scan
description: Scan the pull request for introduced vulnerabilities
inputs:
  api-token:
    description: Symbiotic Organization Access Token
    required: true
  scan-type:
    description: Type of scan to run
    required: false
    default: "all"
    options:
      - infra
      - code
      - all
  upload-results:
    description: Whether to upload the scan results to Symbiotic
    required: false
    default: "true"

runs:
  using: "composite"
  steps:
    - name: Start PR Scan
      run: echo "Starting PR Scan..."
      shell: bash

    # Checkout base branch with full history to collect first commit SHA
    - name: Checkout base branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.base_ref }}

    # Collect remote URL and first commit SHA
    - name: Collect git info
      id: git-info
      if: inputs.upload-results == 'true'
      shell: bash
      run: |
        echo -e "\033[1;34m‚≠ê Collecting git information...\033"

        remote_url="$(git config --get remote.origin.url)"
        first_commit_sha="$(git rev-list --max-parents=0 HEAD | head -n 1)"

        echo "remote_url=$remote_url" >> "$GITHUB_OUTPUT"
        echo "first_commit_sha=$first_commit_sha" >> "$GITHUB_OUTPUT"
      
    - name: Run Code Scan
      id: code-scan-base-branch
      if: inputs.scan-type == 'code' || inputs.scan-type == 'all'
      continue-on-error: true
      env:
        SYMBIOTIC_API_TOKEN: ${{ inputs.api-token }}
        SYMBIOTIC_TARGET_API: https://api.preprod.symbioticsec.ai
      shell: bash
      run: |
        echo -e "\033[1;36müíª Running code scan...\033[0m"
        if [[ "${{ inputs.upload-results }}" == "true" ]]; then
          scan_output=$(symbiotic-cli ci code ./ \
            --skip-output-formatting \
            --git-remote-url "${{ steps.git-info.outputs.remote_url }}" \
            --git-first-commit-sha "${{ steps.git-info.outputs.first_commit_sha }}" \
            --git-latest-commit-sha "${{ github.event.pull_request.base.sha }}" \
            --git-default-branch "${{ github.event.repository.default_branch }}" \
            --git-current-branch "${{ github.base_ref }}")
        else
          scan_output=$(symbiotic-cli ci code ./ --skip-upload-results --skip-output-formatting)
        fi
        
        # Syntax to handle multi-line output in GitHub Actions outputs
        # Use random delimiter to avoid conflicts
        delimiter="EOF_$(openssl rand -hex 8)"
        {
          echo "scan_output<<${delimiter}"
          printf '%s' "${scan_output}"
          echo ""
          echo "${delimiter}"
        } >> "$GITHUB_OUTPUT"

    - name: Run Infra Scan
      id: infra-scan-base-branch
      if: inputs.scan-type == 'infra' || inputs.scan-type == 'all'
      continue-on-error: true
      env:
        SYMBIOTIC_API_TOKEN: ${{ inputs.api-token }}
        SYMBIOTIC_TARGET_API: https://api.preprod.symbioticsec.ai
      shell: bash
      run: |
        echo -e "\033[1;35müèóÔ∏è  Running infrastructure scan...\033[0m"
        if [[ "${{ inputs.upload-results }}" == "true" ]]; then
          scan_output=$(symbiotic-cli ci infra ./ \
            --skip-output-formatting \
            --git-remote-url "${{ steps.git-info.outputs.remote_url }}" \
            --git-first-commit-sha "${{ steps.git-info.outputs.first_commit_sha }}" \
            --git-latest-commit-sha "${{ github.event.pull_request.base.sha }}" \
            --git-default-branch "${{ github.event.repository.default_branch }}" \
            --git-current-branch "${{ github.base_ref }}")
        else
          scan_output=$(symbiotic-cli ci infra ./ --skip-upload-results --skip-output-formatting)
        fi

        # Syntax to handle multi-line output in GitHub Actions outputs
        # Use random delimiter to avoid conflicts
        delimiter="EOF_$(openssl rand -hex 8)"
        {
          echo "scan_output<<${delimiter}"
          printf '%s' "${scan_output}"
          echo ""
          echo "${delimiter}"
        } >> "$GITHUB_OUTPUT"

    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: Run Code Scan
      id: code-scan-pr-branch
      if: inputs.scan-type == 'code' || inputs.scan-type == 'all'
      continue-on-error: true
      env:
        SYMBIOTIC_API_TOKEN: ${{ inputs.api-token }}
        SYMBIOTIC_TARGET_API: https://api.preprod.symbioticsec.ai
      shell: bash
      run: |
        echo -e "\033[1;36müíª Running code scan...\033[0m"
        if [[ "${{ inputs.upload-results }}" == "true" ]]; then
          scan_output=$(symbiotic-cli ci code ./ \
            --skip-output-formatting \
            --git-remote-url "${{ steps.git-info.outputs.remote_url }}" \
            --git-first-commit-sha "${{ steps.git-info.outputs.first_commit_sha }}" \
            --git-latest-commit-sha "${{ github.event.pull_request.head.sha }}" \
            --git-default-branch "${{ github.event.repository.default_branch }}" \
            --git-current-branch "${{ github.head_ref }}")
        else
          scan_output=$(symbiotic-cli ci code ./ --skip-upload-results --skip-output-formatting)
        fi

        # Syntax to handle multi-line output in GitHub Actions outputs
        # Use random delimiter to avoid conflicts
        delimiter="EOF_$(openssl rand -hex 8)"
        {
          echo "scan_output<<${delimiter}"
          printf '%s' "${scan_output}"
          echo ""
          echo "${delimiter}"
        } >> "$GITHUB_OUTPUT"

    - name: Run Infra Scan
      id: infra-scan-pr-branch
      if: inputs.scan-type == 'infra' || inputs.scan-type == 'all'
      continue-on-error: true
      env:
        SYMBIOTIC_API_TOKEN: ${{ inputs.api-token }}
        SYMBIOTIC_TARGET_API: https://api.preprod.symbioticsec.ai
      shell: bash
      run: |
        echo -e "\033[1;35müèóÔ∏è  Running infrastructure scan...\033[0m"
        if [[ "${{ inputs.upload-results }}" == "true" ]]; then
          scan_output=$(symbiotic-cli ci infra ./ \
            --skip-output-formatting \
            --git-remote-url "${{ steps.git-info.outputs.remote_url }}" \
            --git-first-commit-sha "${{ steps.git-info.outputs.first_commit_sha }}" \
            --git-latest-commit-sha "${{ github.event.pull_request.head.sha }}" \
            --git-default-branch "${{ github.event.repository.default_branch }}" \
            --git-current-branch "${{ github.head_ref }}")
        else
          scan_output=$(symbiotic-cli ci infra ./ --skip-upload-results --skip-output-formatting)
        fi

        # Syntax to handle multi-line output in GitHub Actions outputs
        # Use random delimiter to avoid conflicts
        delimiter="EOF_$(openssl rand -hex 8)"
        {
          echo "scan_output<<${delimiter}"
          printf '%s' "${scan_output}"
          echo ""
          echo "${delimiter}"
        } >> "$GITHUB_OUTPUT"

    - name: Log Infra Scans Outputs
      if: inputs.scan-type == 'infra' || inputs.scan-type == 'all'
      shell: bash
      run: |
        echo -e "\033[1;34müìÑ Infra Scan - Base Branch Output:\033[0m"
        printf '%s\n' '${{ steps.infra-scan-base-branch.outputs.scan_output }}'
        echo -e "\033[1;34müìÑ Infra Scan - PR Branch Output:\033[0m"
        printf '%s\n' '${{ steps.infra-scan-pr-branch.outputs.scan_output }}'

    - name: Log Code Scans Outputs
      if: inputs.scan-type == 'code' || inputs.scan-type == 'all'
      shell: bash
      run: |
        echo -e "\033[1;34müìÑ Code Scan - Base Branch Output:\033[0m"
        printf '%s\n' '${{ steps.code-scan-base-branch.outputs.scan_output }}'
        echo -e "\033[1;34müìÑ Code Scan - PR Branch Output:\033[0m"
        printf '%s\n' '${{ steps.code-scan-pr-branch.outputs.scan_output }}'

    - name: Run code scan diff
      id: code-scan-diff
      if: inputs.scan-type == 'code' || inputs.scan-type == 'all'
      continue-on-error: true
      shell: bash
      run: |
        echo -e "\033[1;33müîç Comparing code scan results between base and PR branches...\033[0m"
        symbiotic-cli scan-diff --ci-formatting \
          "${{ steps.code-scan-base-branch.outputs.scan_output }}" \
          "${{ steps.code-scan-pr-branch.outputs.scan_output }}"

    - name: Run infra scan diff
      id: infra-scan-diff
      if: inputs.scan-type == 'infra' || inputs.scan-type == 'all'
      continue-on-error: true
      shell: bash
      run: |
        echo -e "\033[1;33müîç Comparing infrastructure scan results between base and PR branches...\033[0m"
        symbiotic-cli scan-diff --ci-formatting \
          "${{ steps.infra-scan-base-branch.outputs.scan_output }}" \
          "${{ steps.infra-scan-pr-branch.outputs.scan_output }}"
    
    - name: Check Results
      shell: bash
      run: |
        # Check if any scan failed and exit with code 1
        if [[ "${{ steps.code-scan-diff.outcome }}" == "failure" ]] || [[ "${{ steps.infra-scan-diff.outcome }}" == "failure" ]]; then
          exit 1
        fi
